<!DOCTYPE>
<html lang="en">
    {% load static %}
    <title>AirSafe - Home</title>
    <link rel="shortcut icon" type="image/png" href="{% static "logo.png" %}"/>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <style>      
        html { width: 100%; height: 100%; /*overflow: hidden;*/ }
        body { width: 100%; height: auto; overflow: hidden; margin: auto; }
        .container-fluid { padding-left: 0px; padding-right: 0px; }
        #heading { margin: auto; position: fixed; z-index: 10; width: 99%; height: auto;  background: #888FA8; color: white; }
        #title { width: 100%; margin-left: 2%; }
        #logo { width: 9%; display: inline-block; }
        #title-text { font-size: 2vw; display: inline-block; margin-left: 2%; margin-top: 2%; }
        #navigation, .navbar { width: 100%; }
        .nav { border: 1px solid white; width: 20%; background: #5B76D4; color: white; font-size: 2vw; }
        #search { width: 80%; margin: auto; font-size: 1.5vw; }
        #search-form { width: 100%; margin: auto; }
        #body_block { position: relative; width: 100%; height: 100%; overflow: hidden; scroll-behavior: smooth; }
        #footer { width: 100%; height: 40px; }
        section { width: 100%; height: 700px; border-bottom: 1px solid black; }
        .container-fluid { margin: auto; }
        #subscribe_board, #verify_email_board, #subscribe_done_board
        { width: 800px; height: 300px; margin-top: 60px; margin-left: auto;
        	margin-right: auto; border-width: 1px; border-style: solid;
        	text-align: center; padding-top: 10px; }
        #verify_email_board, #subscribe_done_board { display: none; }
        #subscribe_table { width: 500px; margin-left: 250px; }
        #subscribe_table tr { height: 40px; }
        #subscribe_email { width: 300px; }
        #subscribe_zipcode { width: 100px; }
        #subscribing, #verfication_code, #submit_verfication_code, #subscription_done
        { margin-top: 30px; }
        #loading-block { display: none; }
        span { margin: auto; font-weight: bold; }
        #container, #pastData { max-width: 99%; }

        #body_block::-webkit-scrollbar {
            width: 12px;
            background-color: #F5F5F5; 
        }

        #body_block::-webkit-scrollbar-thumb {
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1);
            box-shadow: insert 0 0 6px rgba(0, 0, 0, 0.1);
            background-color: #4285F4; 
        }
    </style>

<body>
    <div class="container-fluid">
    <div id="heading">
        <div id="title"><img id="logo" src="{% static "logo.png" %}"><h3 id="title-text" >AirSafe: Quality Monitoring System</h3></div>
        <div id="navigation">
            <nav class="navbar navbar-inverse navbar-fixed-top collapse.navbar-collapse" id="navbar" >
                <button class="nav" id="home_button" onclick="window.location.href='#air-safe'"><span>Air Monitor</span></button>
                <button class="nav" id="forecast_button" onclick="window.location.href='#forecast'"><span>Forecast<span></button>
                <button class="nav" id="past_data_button" onclick="window.location.href='#past'"><span>Past Data</span></button>
                <button class="nav" id="about_us_button" onclick="window.location.href='#about'"><span>About Us</span></button>
                <button class="nav" id="subscribe_button" onclick="window.location.href='#subscribe'"><span>Subscribe</span></button>
            </nav>
        </div>
        <div id="search">
            <form id="search-form">
                Search: <input id="result" type="text" name="search" style="width: 70%;" placeholder="Enter a city,state or zip code">
                <input id="search-button" type="button" name="search-button" value="Search">
            </form><br><br>
        </div>
    </div>
    <div id="loading-block">
        <img src="{% static "loading.gif" %}">
    </div>
    <div id="body_block" class="scrollbar scrollbar-primary" data-spy="scroll" data-target=".navbar">
        <section id="air-safe">
            This is the air safe section
        </section>
        <section id="forecast">
            <div id="container"></div>
        </section>
        <section id="past">
            <div id="pastData"></div>
        </section>
        <section id="about">
            This is the about us section
        </section>
        <section id="subscribe">
            <div id="subscribe_board">
            	<p><h3>Subscribe to receive new air quality information every day!</h3>
            	   (Note: To update subscribed zipcode, subscribe again with the same email and the new zipcode)
            	</p>
            	<table id="subscribe_table">
            		<tr>
            			<td>Email:</td>
            			<td><input type="text" id="subscribe_email" name="subscribe_email"></td>
            		</tr>
            		<tr>
            			<td>Zipcode:</td>
            			<td><input type="text" id="subscribe_zipcode" name="subscribe_zipcode"></td>
            		</tr>
            	</table>
            	<button id="subscribing" name="subscribing">Subscribe</button>
            </div>
            <div id="verify_email_board">
            	<p style="margin-top: 50px;"><h3>Enter your verification code</h3>
                 We have emailed you a verification code. Please check your email and enter the verfication code.
              </p>
            	<input type="text" id="verfication_code" name="verfication_code"></td>
            	<button id="submit_verfication_code" name="submit_verfication_code">Submit</button>
            </div>
            <div id="subscribe_done_board">
            	<p style="margin-top: 80px;"><h3>Thank you for subscription!</h3></p>
            	<button id="subscription_done" name="subscription_done">Done</button>
            </div>
        </section>
    </div>
    <div id="footer">
    </div>
</div>
    <script>
        $("#body_block").css("top", $("#heading").css("height"));
        $("#body_block").on("mouseenter", function(event) {
            $(this).css("overflow-y", "auto");
        });

        $("#body_block").on("mouseleave", function(event) {
            $(this).css("overflow-y", "hidden");
        });

        $(".nav")[0].style.background = "#475CA7";

        $(".nav").on("click", function(event) {
            var navs = $(".nav").each(function(index, value) {
                value.style.background = "#5B76D4";
            });

            $(this).css("background", "#475CA7");
        });

        $(window).on("load", function(event) {
            $("#result").val("95112");
            $("#search-button").click();
            var importedData = JSON.stringify({{ import|safe }});
            $("#air-safe").html(importedData);
        });

        $(document).ajaxStart(function() {
            $("#body_block").css("display", "none");
            $("#loading-block").css("display", "block");
        });

        $(document).ajaxStop(function() {
            $("#loading-block").css("display", "none");
            $("#body_block").css("display", "block");
        });

        $("#search-button").on("click", function(event) {
            var results = $("#result").val();
            var search = "";

            $("#result").val("");

            console.log(results)

            if (results.match(/[0-9]{5}/)) {
                search = "zip=" + results + "&city=" + "&state=";
            }
            else if (results.match(/[a-zA-Z]+,[a-zA-Z]+/)) {
                city_state = results.split(",");
                search = "zip=&city=" + city_state[0] + "&state=" + city_state[1];
            }
            else if (results.match(/[a-zA-Z]+/)) {
                search = "zip=&city=" + results + "&state=";
            }
            else {
                alert("Please provide input in either of these formats: 1. city,state 2. city 3. zipcode");
                return;
            }

            $.ajax({
                'url': "/latest?" + search,
                'type': "GET",
                'success': function(data) {
                    console.log(data);
                    parsedData = JSON.parse(data);
                    search = "zip=" + parsedData.zipcode;
                    console.log(search)
                     $.ajax({
                        'url': "/future?" + search,
                        'type': "GET",
                        'success': function(newData) {
                            futureData(newData, results);
                        },
                        'error': function(error) {

                        }
                    });
                    $.ajax({
                        'url' : '/GetData?' + search,
                        'type' : 'GET',
                        'success' : function(data) {
                            pastData(data);
                        },
                        'error' : function(request,error)
                        {
                            alert("Request: "+JSON.stringify(request));
                        }
                    });
                },
                'error': function(error) {

                }

            });

        });

        function futureData(data, location) {
            var x =JSON.parse(data);
            var y = [];

            for(var i=0;i<x.length;i++){
                y[i]= [Date.parse(x[i].stamp), Math.round(x[i].pm)];
            }

            Highcharts.chart('container', {
                title: {
                    text: 'Forecast for ' + location
                },

                subtitle: {
                    text: 'Data for next ' + y.length
                },

                yAxis: {
                    title: {
                        text: 'PM2.5'
                    }
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle'
                },
                xAxis: {
                    type: "datetime",
                    dateTimeLabelFormats: {
                        format: "%Y-%m-%d"
                    }
                },
                series: [{
                    name: location,
                    data: y
                }],

                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }

            });
        }

        function pastData(data) {
            var AQpm=[];
            var AQozone=[];
            var AQstamp = [];

            x =JSON.parse(data);

            for(var i=0;i<x.length;i++){
                AQpm[i]=x[i].pm;
                AQozone[i]=x[i].ozone;
                AQstamp[i] =x[i].stamp;
            }

             Highcharts.chart('pastData', {
                chart: {
                    type: 'column'
                },
                title: {
                    text: 'Air Pollution past data'
                },
                subtitle: {
                    text: 'Data From past 7 days'
                },
                xAxis: {
                    categories:AQstamp,
                    crosshair: true
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'Aip Polutant (mm)'
                    }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y:.1f} mm</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        pointPadding: 0.2,
                        borderWidth: 0
                    }
                },
                series: [{
                    name: 'PM',
                    data: AQpm

                }, {
                    name: 'Ozone',
                    data: AQozone

                }]
            });
        }

        $("#subscribing").on("click", function(event){
          if($("#subscribe_email").val().trim() == "") {
            $("#subscribe_email").val("");
            alert("Please enter your email!");
          }
          else if($("#subscribe_zipcode").val().trim() == "") {
            $("#subscribe_zipcode").val("");
            alert("Please enter a zipcode!");
          }
          else {
            var email = $("#subscribe_email").val().trim();
            var zipcode = $("#subscribe_zipcode").val().trim();
            if(!zipcode.match(/^\d{5}$/)) {
              alert("Please enter 5 digits zipcode");
            }
            else {
              var req = new XMLHttpRequest();
              req.onreadystatechange = function(event) {
                  if(this.status == 200 && this.readyState == 4) {
                    if(this.responseText == "error") {
                      alert("Please enter a valid email");
                      $("#subscribe_email").val("");
                      $("#subscribe_zipcode").val("");
                    }
                    else if(this.responseText == "no data") {
                      alert("Sorry, Zipcode " + zipcode + " currently has no available air quality data");
                    }
                    else {
                      verification_code = this.responseText;
                      $("#subscribe_board").css("display", "none");
                      $("#verify_email_board").css("display", "block");
                    }
                  }
              }
              var url = "/verifyEmailAndZipcode?email=" + email + "&zipcode=" + zipcode;
              req.open("get", url);
              req.send();
            }
          }
        });

        $("#submit_verfication_code").on("click", function(event){
          if($("#verfication_code").val().trim() != verification_code) {
            $("#verfication_code").val("");
            alert("Verfication code is invalid!");
          }
          else {
            var email = $("#subscribe_email").val().trim();
            var zipcode = $("#subscribe_zipcode").val().trim();
            var req = new XMLHttpRequest();
            req.onreadystatechange = function(event) {
                if(this.status == 200 && this.readyState == 4) {
                  $("#verify_email_board").css("display", "none");
                  $("#subscribe_done_board").css("display", "block");
                }
            }
            var url = "/subscription?email=" + email + "&zipcode=" + zipcode;
            req.open("get", url);
            req.send();
          }
        });

        $("#subscription_done").on("click", function(event){
          verification_code = ""
          $("#subscribe_email").val("");
          $("#subscribe_zipcode").val("");
          $("#verfication_code").val("");
          $("#subscribe_done_board").css("display", "none");
          $("#subscribe_board").css("display", "block");
        });
    </script>
</body>
</html>
